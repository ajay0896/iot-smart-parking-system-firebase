<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Parkir IoT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .card-custom { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); transition: 0.3s; }
        .card-custom:hover { transform: translateY(-5px); }
        .spinner-scan { width: 4rem; height: 4rem; border-width: 0.3em; }
        .bg-gradient-primary { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
        .status-badge { font-size: 0.85em; padding: 0.5em 1em; border-radius: 20px; }
        /* Animasi Blink untuk Waiting Scan */
        .blink-text { animation: blinker 1.5s linear infinite; font-weight: bold; color: #0d6efd; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 py-3">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-parking text-warning"></i> SISTER PARKIR
            </a>
            <div class="d-flex">
                <button v-if="view !== 'home'" @click="view = 'home'" class="btn btn-outline-light btn-sm rounded-pill px-3">
                    <i class="fas fa-home"></i> Menu Utama
                </button>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div v-if="view === 'home'" class="row g-4 justify-content-center">
            <div class="col-12 text-center mb-2">
                <h3 class="fw-bold text-dark">Dashboard Kontrol</h3>
                <p class="text-muted">Pilih menu untuk memulai</p>
            </div>

            <div class="col-md-4 col-sm-6">
                <div class="card card-custom h-100" @click="view = 'register'" style="cursor: pointer;">
                    <div class="card-body text-center p-5">
                        <div class="bg-light rounded-circle d-inline-block p-3 mb-3">
                            <i class="fas fa-user-plus fa-3x text-primary"></i>
                        </div>
                        <h5>Registrasi User</h5>
                        <p class="text-muted small mb-0">Daftarkan kartu baru dengan metode Web-Trigger</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 col-sm-6">
                <div class="card card-custom h-100" @click="view = 'logs'" style="cursor: pointer;">
                    <div class="card-body text-center p-5">
                        <div class="bg-light rounded-circle d-inline-block p-3 mb-3">
                            <i class="fas fa-chart-line fa-3x text-success"></i>
                        </div>
                        <h5>Data Perjalanan</h5>
                        <p class="text-muted small mb-0">Lihat siapa yang masuk/keluar secara realtime</p>
                    </div>
                </div>
            </div>

            <div class="col-md-4 col-sm-6">
                <div class="card card-custom h-100" style="cursor: pointer;" @click="initializeDummyData">
                    <div class="card-body text-center p-5">
                        <div class="bg-light rounded-circle d-inline-block p-3 mb-3">
                            <i class="fas fa-database fa-3x text-warning"></i>
                        </div>
                        <h5>Initialize Data</h5>
                        <p class="text-muted small mb-0">Muat data dummy ke Firebase (untuk testing)</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'register'" class="row justify-content-center">
            <div class="col-md-6 col-lg-5">
                <div class="card card-custom">
                    <div class="card-header bg-white border-0 pt-4 px-4">
                        <h5 class="fw-bold"><i class="fas fa-id-card"></i> Form Registrasi</h5>
                    </div>
                    <div class="card-body px-4 pb-4">
                        <form @submit.prevent="triggerScan">
                            <div class="mb-3">
                                <label class="form-label small text-muted">Nama Lengkap</label>
                                <input v-model="form.nama" type="text" class="form-control" placeholder="Contoh: Budi Santoso" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small text-muted">Nomor WhatsApp</label>
                                <input v-model="form.wa" type="number" class="form-control" placeholder="62812xxxx (Tanpa +)" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small text-muted">Password Akun</label>
                                <input v-model="form.pass" type="password" class="form-control" required>
                            </div>
                            
                            <div class="d-grid mt-4">
                                <button type="submit" class="btn btn-primary py-2 rounded-pill shadow-sm">
                                    Lanjut Scan Kartu <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'logs'">
            <div class="card card-custom">
                <div class="card-header bg-white border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold m-0">Live Monitoring</h5>
                    <span class="badge bg-success rounded-pill">Realtime <i class="fas fa-wifi"></i></span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Waktu</th>
                                    <th>Nama</th>
                                    <th>Gate</th>
                                    <th>Status</th>
                                    <th>Tarif</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="log in logs" :key="log.id">
                                    <td class="small">{{ log.waktu }}</td>
                                    <td class="fw-bold">{{ log.nama }} <br><small class="text-muted fw-normal">{{ log.uid }}</small></td>
                                    <td>{{ log.gate }}</td>
                                    <td>
                                        <span class="badge" 
                                            :class="log.status === 'Check-In' ? 'bg-success' : 'bg-danger'">
                                            {{ log.status }}
                                        </span>
                                    </td>
                                    <td>{{ log.biaya ? 'Rp ' + formatRupiah(log.biaya) : '-' }}</td>
                                </tr>
                                <tr v-if="logs.length === 0">
                                    <td colspan="5" class="text-center text-muted py-4">Belum ada data perjalanan hari ini.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div v-if="isScanning" class="fixed-top w-100 h-100 bg-dark bg-opacity-75 d-flex align-items-center justify-content-center" style="z-index: 9999;">
        <div class="card text-center p-5 shadow-lg border-0" style="max-width: 400px; border-radius: 20px;">
            
            <div v-if="!scanSuccess">
                <div class="spinner-border text-primary spinner-scan mb-4" role="status"></div>
                <h4 class="fw-bold mb-2">Menunggu Tap Kartu...</h4>
                <p class="text-muted mb-4">Tempelkan kartu pada alat Gate Masuk sekarang.</p>
                <p class="blink-text small"><i class="fas fa-satellite-dish"></i> Sistem Siap Menerima UID</p>
                <button @click="cancelScan" class="btn btn-light rounded-pill px-4 mt-3">Batal</button>
            </div>

            <div v-else>
                <i class="fas fa-check-circle text-success" style="font-size: 5rem;"></i>
                <h4 class="fw-bold mt-3">Kartu Terhubung!</h4>
                <p class="text-muted">UID: {{ tempUid }}</p>
                <p class="small text-primary">Mengalihkan ke menu utama...</p>
            </div>

        </div>
    </div>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // KONFIGURASI FIREBASE ANDA
    const firebaseConfig = {
        apiKey: "AIzaSyCjRx1OXGSH_uAKDq-7ajVykOtHTNHQUwY",
        authDomain: "siste-parkir-iot.firebaseapp.com",
        databaseURL: "https://siste-parkir-iot-default-rtdb.firebaseio.com",
        projectId: "siste-parkir-iot",
        storageBucket: "siste-parkir-iot.firebasestorage.app",
        messagingSenderId: "874240075946",
        appId: "1:874240075946:web:91e21678f4779060c6c8d3",
        measurementId: "G-E3QYQJ9LDQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const { createApp, ref: vueRef, onMounted } = Vue;

    createApp({
        setup() {
            const view = vueRef('home');
            const form = vueRef({ nama: '', wa: '', pass: '' });
            const isScanning = vueRef(false);
            const scanSuccess = vueRef(false);
            const tempUid = vueRef('');
            const logs = vueRef([]);

            // === FUNGSI REGISTRASI WEB-TRIGGERED ===
            const triggerScan = () => {
                isScanning.value = true;
                scanSuccess.value = false;
                
                // 1. Beritahu Firebase: "Alat, masuk mode REGISTER ya!"
                set(ref(db, 'system/mode'), 'REGISTER');
                set(ref(db, 'system/temp_rfid'), ''); 

                // 2. Monitoring folder 'temp_rfid' menunggu inputan ESP32
                const tempRef = ref(db, 'system/temp_rfid');
                const unsubscribe = onValue(tempRef, (snapshot) => {
                    const uid = snapshot.val();
                    if (uid && uid !== "" && isScanning.value) {
                        // KARTU DITEMPEL!
                        tempUid.value = uid;
                        scanSuccess.value = true;
                        
                        // Simpan Data Lengkap
                        setTimeout(() => {
                            saveFinalData(uid);
                        }, 1500); // Delay biar user lihat centang hijau dulu
                    }
                });
            };

            const saveFinalData = (uid) => {
                const newUser = {
                    nama: form.value.nama,
                    wa: form.value.wa,
                    password: form.value.pass,
                    saldo: 50000, // Bonus saldo awal
                    status_terakhir: 'BARU'
                };

                set(ref(db, 'users/' + uid), newUser)
                .then(() => {
                    // Reset Alat ke Mode Normal
                    set(ref(db, 'system/mode'), 'NORMAL');
                    set(ref(db, 'system/temp_rfid'), '');
                    
                    isScanning.value = false;
                    view.value = 'home';
                    form.value = { nama: '', wa: '', pass: '' };
                    alert("User berhasil didaftarkan!");
                });
            };

            const cancelScan = () => {
                isScanning.value = false;
                set(ref(db, 'system/mode'), 'NORMAL');
            };

            // === FUNGSI INISIALISASI DATA DUMMY ===
            const initializeDummyData = async () => {
                if (!confirm('Ini akan menimpa data di Firebase. Lanjutkan?')) return;
                
                const dummyData = {
                    system: {
                        mode: "NORMAL",
                        temp_rfid: ""
                    },
                    users: {
                        "A1B2C3D4": {
                            nama: "Budi Santoso",
                            password: "123",
                            saldo: 47000,
                            status_terakhir: "KELUAR",
                            wa: "08123456789"
                        },
                        "E5F6G7H8": {
                            nama: "Siti Aminah",
                            password: "abc",
                            saldo: 15000,
                            status_terakhir: "MASUK",
                            wa: "08987654321"
                        },
                        "99887766": {
                            nama: "Dedi Corbuzier",
                            password: "gym",
                            saldo: 950000,
                            status_terakhir: "BARU",
                            wa: "081122334455"
                        }
                    },
                    logs: {
                        "1710001000": {
                            biaya: 0,
                            gate: "MASUK",
                            nama: "Budi Santoso",
                            status: "Check-In",
                            timestamp: 1710001000,
                            uid: "A1B2C3D4",
                            waktu: "08:00:00"
                        },
                        "1710002500": {
                            biaya: 0,
                            gate: "MASUK",
                            nama: "Siti Aminah",
                            status: "Check-In",
                            timestamp: 1710002500,
                            uid: "E5F6G7H8",
                            waktu: "08:25:00"
                        },
                        "1710005000": {
                            biaya: 3000,
                            gate: "KELUAR",
                            nama: "Budi Santoso",
                            status: "Check-Out",
                            timestamp: 1710005000,
                            uid: "A1B2C3D4",
                            waktu: "09:05:00"
                        },
                        "1710006000": {
                            biaya: 0,
                            gate: "MASUK",
                            nama: "Dedi Corbuzier",
                            status: "Check-In",
                            timestamp: 1710006000,
                            uid: "99887766",
                            waktu: "09:30:00"
                        },
                        "1710007200": {
                            biaya: 3000,
                            gate: "KELUAR",
                            nama: "Dedi Corbuzier",
                            status: "Check-Out",
                            timestamp: 1710007200,
                            uid: "99887766",
                            waktu: "10:00:00"
                        }
                    }
                };

                try {
                    await set(ref(db, '/'), dummyData);
                    alert('Data dummy berhasil dimuat ke Firebase!');
                } catch (err) {
                    console.error('Error:', err);
                    alert('Gagal memuat data: ' + err.message);
                }
            };

            // === FUNGSI MONITORING LOG ===
            onMounted(() => {
                const logRef = ref(db, 'logs');
                onValue(logRef, (snapshot) => {
                    const data = snapshot.val();
                    if(data) {
                        // Ubah Object ke Array lalu Sortir dari yang terbaru
                        const arr = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                        logs.value = arr.sort((a,b) => b.timestamp - a.timestamp);
                    }
                });
            });

            const formatRupiah = (angka) => {
                return new Intl.NumberFormat('id-ID').format(angka);
            }

            return {
                view, form, isScanning, scanSuccess, tempUid, logs,
                triggerScan, cancelScan, initializeDummyData, formatRupiah
            };
        }
    }).mount('#app');
</script>
</body>
</html>